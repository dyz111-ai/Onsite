# JWT 用户认证系统使用说明

## 已完成功能

✅ 用户注册
✅ 用户登录
✅ JWT Token 认证
✅ 获取当前用户信息
✅ 修改密码
✅ 前端路由守卫
✅ Token 自动过期处理

## 安装步骤

### 1. 安装后端依赖

```bash
cd backend
pip install -r requirements.txt
```

新增的依赖：
- `PyJWT==2.8.0` - JWT token 生成和验证
- `psycopg2-binary==2.9.9` - PostgreSQL 数据库驱动

### 2. 启动后端服务

```bash
cd backend
python -m app.main
```

服务运行在 `http://localhost:8000`

### 3. 启动前端服务

```bash
cd frontend
npm install
npm run dev
```

前端运行在 `http://localhost:5173`

## 使用流程

### 1. 注册新用户
- 访问 `http://localhost:5173/login`
- 点击"立即注册"
- 填写用户名（3-20字符）、密码（至少6位）
- 注册成功后自动登录并跳转到首页

### 2. 登录
- 访问 `http://localhost:5173/login`
- 输入用户名和密码
- 登录成功后跳转到首页

### 3. 访问受保护页面
- 所有页面（除登录页）都需要登录才能访问
- 未登录时会自动跳转到登录页
- Token 有效期为 24 小时

### 4. 退出登录
在前端代码中调用：
```javascript
import { logout } from '@/utils/auth'
logout()
```

## API 接口

### 注册
```
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "123456"
}
```

### 登录
```
POST /api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "123456"
}
```

### 获取当前用户
```
GET /api/auth/me
Authorization: Bearer <token>
```

### 修改密码
```
POST /api/auth/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "old_password": "123456",
  "new_password": "newpassword"
}
```

## 文件结构

### 后端
```
backend/
├── app/
│   ├── api/
│   │   └── auth.py          # 认证路由
│   ├── models/
│   │   └── user.py          # 用户模型
│   ├── utils/
│   │   └── jwt_utils.py     # JWT 工具函数
│   ├── config.py            # 配置文件
│   └── main.py              # 主程序（已更新）
├── data/
│   └── users.json           # 用户数据存储
└── requirements.txt         # 依赖（已更新）
```

### 前端
```
frontend/
├── src/
│   ├── api/
│   │   └── auth.js          # 认证 API
│   ├── views/
│   │   └── Login.vue        # 登录注册页面
│   ├── utils/
│   │   └── auth.js          # 认证工具函数
│   └── main.js              # 路由配置（已更新）
```

## 安全配置

### 生产环境配置

在生产环境中，需要修改 `backend/app/config.py` 中的密钥：

```python
SECRET_KEY = 'your-production-secret-key'
JWT_SECRET_KEY = 'your-production-jwt-secret-key'
```

建议使用环境变量：
```bash
export SECRET_KEY="your-secret-key"
export JWT_SECRET_KEY="your-jwt-secret-key"
```

## 数据存储

用户数据存储在 PostgreSQL 数据库的 `participant` 表中，包含：
- participant_id（主键，自增）
- account（用户名）
- password（密码哈希，使用 werkzeug 加密）

**注意**：数据库连接配置在 `backend/app/database.py` 中。

## 前端集成示例

### 在组件中获取当前用户
```javascript
import { getCurrentUser } from '@/utils/auth'

const user = getCurrentUser()
console.log(user.username)
```

### 在 API 请求中自动添加 Token
```javascript
import api from '@/api/auth'

// Token 会自动添加到请求头
const response = await api.get('/api/some-protected-route')
```

### 退出登录
```javascript
import { logout } from '@/utils/auth'

logout() // 清除本地存储并跳转到登录页
```

## 测试

### 测试注册
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'
```

### 测试登录
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'
```

### 测试获取用户信息
```bash
curl -X GET http://localhost:8000/api/auth/me \
  -H "Authorization: Bearer <your_token>"
```
